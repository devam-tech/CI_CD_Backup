pipeline {
    agent none

    environment {
        REPO_URL       = 'https://github.com/MultiiconIdeotechnology/MM_Broker_Simulation_API.git'
        REPO_BRANCH    = 'main'
        GIT_CRED       = 'MM_PAT'

        DOTNET_PROJECT = 'SimulationBrokerAPI.sln' 
        PUBLISH_DIR    = 'publish_output'
        DEPLOY_ROOT    = 'C:\\jenkins-agent\\Testing\\MarketMaya\\SimulationAPI'    
        APP_POOL_NAME  = ''  
    }

    stages {
        stage('Build') {
            agent { label 'built-in' }

            stages {
                stage('Checkout') {
                    steps {
                        echo "üîÑ Checking out '${env.REPO_BRANCH}' from '${env.REPO_URL}'..."
                        checkout([$class: 'GitSCM',
                            branches: [[name: "*/${env.REPO_BRANCH}"]],
                            userRemoteConfigs: [[url: "${env.REPO_URL}", credentialsId: "${env.GIT_CRED}"]]
                        ])
                    }
                }

                stage('Build & Publish') {
                    steps {
                        echo 'üõ† Restoring, building, and publishing project...'
                        bat "dotnet restore ${env.DOTNET_PROJECT}"
                        bat "dotnet build ${env.DOTNET_PROJECT} -c Release"
                        bat "dotnet publish ${env.DOTNET_PROJECT} -c Release -o ${env.PUBLISH_DIR}"
                    }
                }

                stage('Archive & Stash') {
                    steps {
                        echo 'üì¶ Archiving and stashing simulation_output...'
                        archiveArtifacts artifacts: "${env.PUBLISH_DIR}/**", fingerprint: true
                        stash name: 'simulation_output', includes: "${env.PUBLISH_DIR}/**"
                    }
                }
            }
        }

        stage('Deploy') {
            agent { label 'aws-marketmaya-global-window' }

            steps {
                echo 'üöÄ Deploying to IIS...'
                unstash 'simulation_output'
                powershell """
try {
    # Stop App Pool
    Write-Host "üõë Stopping App Pool: ${env.APP_POOL_NAME}"
    \$retries = 10
    while (\$retries -gt 0) {
        try {
            Stop-WebAppPool -Name '${env.APP_POOL_NAME}' -ErrorAction Stop
            Write-Host "‚úÖ App Pool stopped."
            break
        } catch {
            Write-Warning "‚ö† Retry stopping App Pool... (\$retries left)"
            Start-Sleep -Seconds 7
            \$retries--
        }
    }

    # Offline notice
    Set-Content -Path '${env.DEPLOY_ROOT}\\app_offline.html' -Value '<html>Updating, please wait...</html>'

    # Deploy files (no delete, only update)
    robocopy '${env.WORKSPACE}\\${env.PUBLISH_DIR}' '${env.DEPLOY_ROOT}' /E /XO /XF web.config *.json /NFL /NDL /NP
    \$rc = \$LASTEXITCODE
    Write-Host "üîπ Robocopy Exit Code: \$rc"

    # Remove offline file
    Remove-Item '${env.DEPLOY_ROOT}\\app_offline.html' -Force -ErrorAction SilentlyContinue

    # Start App Pool
    Write-Host "üîÑ Starting App Pool: ${env.APP_POOL_NAME}"
    \$retries = 10
    while (\$retries -gt 0) {
        try {
            Start-WebAppPool -Name '${env.APP_POOL_NAME}' -ErrorAction Stop
            Write-Host "‚úÖ App Pool started."
            break
        } catch {
            Write-Warning "‚ö† Retry starting App Pool... (\$retries left)"
            Start-Sleep -Seconds 7
            \$retries--
        }
    }

    # Handle robocopy result
    if (\$rc -ge 0 -and \$rc -le 7) {
        Write-Host "üéâ Deployment successful! (Code: \$rc)"
        exit 0
    } elseif (\$rc -gt 7 -and \$rc -lt 16) {
        Write-Warning "‚ö† Deployment completed with warnings. (Code: \$rc)"
        exit 0
    } else {
        Write-Error "‚ùå Deployment failed! (Code: \$rc)"
        exit 1
    }

} catch {
    Write-Error "‚ùå Deployment error: \$_.Exception.Message"
    exit 1
}
"""
            }
        }

        stage('Rollback') {
            when {
                expression { currentBuild.currentResult == "FAILURE" }
            }
            steps {
                echo 'üîÑ Rollback triggered. Restarting IIS App Pool...'
                powershell """
try {
    if ((Get-WebAppPoolState -Name '${env.APP_POOL_NAME}').Value -ne 'Started') {
        Start-WebAppPool -Name '${env.APP_POOL_NAME}'
        Write-Host "‚úÖ App Pool restarted."
    } else {
        Write-Host "‚Ñπ App Pool already running."
    }
} catch {
    Write-Error "‚ùå Rollback failed: \$_.Exception.Message"
}
"""
            }
        }
    }

    post {
        success { echo '‚úÖ Pipeline completed successfully!' }
        failure { echo '‚ùå Pipeline failed. Check logs.' }
        always  { echo 'üìù Pipeline finished.' }
    }
}
