pipeline {
    agent none

    environment {
        REPO_URL     = 'https://github.com/MultiiconIdeotechnology/MM_Web_Partner.git'
        REPO_BRANCH  = 'uat_india'
        GIT_CRED     = 'MM_PAT'

        DEPLOY_ROOT  = 'D:\\jenkins-agent\\Testing\\MarketMaya\\Partner'
        APP_POOL     = 'todoapi.multiicon.in'
        EXCLUDE_FILE = 'web.config'

        // Prepend Node and ensure PowerShell is on PATH
        PATH = "C:\\Program Files\\nvm\\v16.20.2;C:\\Windows\\System32\\WindowsPowerShell\\v1.0;${env.PATH}"
    }

    stages {

        stage('Checkout') {
            agent { label 'built-in' }
            steps {
                checkout([$class: 'GitSCM',
                    branches: [[name: "*/${REPO_BRANCH}"]],
                    userRemoteConfigs: [[url: "${REPO_URL}", credentialsId: "${GIT_CRED}"]]
                ])
            }
        }

        stage('Build Angular') {
            agent { label 'built-in' }
            steps {
                powershell '''
                    Write-Host "üì¶ Using Node & npm version:"
                    node -v
                    npm -v

                    Write-Host "üì¶ Installing npm dependencies..."
                    npm install --legacy-peer-deps
                    if ($LASTEXITCODE -ne 0) { throw "‚ùå npm install failed." }

                    Write-Host "‚ö° Running Angular build (config: production)..."
                    npx ng build --configuration=production
                    if ($LASTEXITCODE -ne 0) { throw "‚ùå Angular build failed." }
                '''
            }
        }

        stage('Prepare Artifacts') {
            agent { label 'built-in' }
            steps {
                powershell '''
                    # Detect build output folder
                    $distFuse = Join-Path $env:WORKSPACE "dist\\fuse"
                    $distBrowser = Join-Path $distFuse "browser"

                    if (Test-Path $distBrowser) {
                        Write-Host "üìÇ Found dist/fuse/browser, using that as build output."
                        $distPath = $distBrowser
                    } elseif (Test-Path $distFuse) {
                        Write-Host "üìÇ Found dist/fuse, using that as build output."
                        $distPath = $distFuse
                    } else {
                        throw "‚ùå Angular build did not produce a dist folder. Checked: $distFuse and $distBrowser"
                    }

                    # Prepare publish_output folder
                    $publishDir = Join-Path $env:WORKSPACE "publish_output"
                    if (Test-Path $publishDir) { Remove-Item $publishDir -Recurse -Force }
                    New-Item -ItemType Directory -Force -Path $publishDir

                    # Copy build artifacts
                    Copy-Item $distPath $publishDir -Recurse
                    Write-Host "‚úÖ Artifacts copied to $publishDir"
                '''
                archiveArtifacts artifacts: 'publish_output/**', fingerprint: true
                stash name: 'angular-artifacts', includes: 'publish_output/**'
            }
        }

        stage('Deploy to IIS') {
            agent { label 'aws-marketmaya-india-windows' }
            steps {
                unstash 'angular-artifacts'
                powershell '''
                    $ErrorActionPreference = "Stop"
                    Import-Module WebAdministration

                    $publishDir = Join-Path $env:WORKSPACE "publish_output"
                    $deployRoot = "$env:DEPLOY_ROOT"
                    $appPool    = "$env:APP_POOL"

                    if (-not (Test-Path $publishDir)) { throw "‚ùå Publish folder not found: $publishDir" }

                    # Stop App Pool
                    $retryCount = 0
                    $maxRetries = 10
                    while ($retryCount -lt $maxRetries) {
                        try {
                            $state = (Get-WebAppPoolState -Name $appPool).Value
                            if ($state -eq 'Stopped') { break }
                            Stop-WebAppPool -Name $appPool -ErrorAction Stop
                        } catch {}
                        Start-Sleep -Seconds 7
                        $retryCount++
                    }
                    if ((Get-WebAppPoolState -Name $appPool).Value -ne 'Stopped') {
                        Write-Warning "‚ö† App Pool '$appPool' did not stop after $maxRetries attempts."
                    } else {
                        Write-Host "‚úÖ App Pool stopped successfully."
                    }

                    # Deploy files
                    & "$env:WINDIR\\System32\\Robocopy.exe" "$env:WORKSPACE\\publish_output\\fuse" "$env:DEPLOY_ROOT" /E /XO /XF "$env:EXCLUDE_FILE" /NFL /NDL /NP
                    $rc = $LASTEXITCODE

                    if ($rc -ge 0 -and $rc -le 7) {
                        Write-Host "üéâ Deployment completed successfully! (Robocopy Exit Code: $rc)"
                        exit 0
                    } elseif ($rc -gt 7 -and $rc -lt 16) {
                        Write-Warning "‚ö† Deployment completed with warnings. (Robocopy Exit Code: $rc)"
                        exit 0
                    } else {
                        Write-Error "‚ùå Deployment failed! (Robocopy Exit Code: $rc)"
                        exit 1
                    }

                    # Start App Pool
                    $retryCount = 0
                    while ($retryCount -lt $maxRetries) {
                        try {
                            Start-WebAppPool -Name $appPool
                        } catch {}
                        Start-Sleep -Seconds 7
                        if ((Get-WebAppPoolState -Name $appPool).Value -eq 'Started') { break }
                        $retryCount++
                    }
                    if ((Get-WebAppPoolState -Name $appPool).Value -ne 'Started') {
                        throw "‚ùå App Pool '$appPool' did not start after $maxRetries attempts."
                    } else {
                        Write-Host "‚úÖ App Pool started successfully."
                    }
                '''
            }
        }

        stage('Deployment Summary') {
            steps {
                echo "üìå Deployment summary for ${APP_POOL} to ${DEPLOY_ROOT}"
            }
        }
    }

    post {
        success { echo "‚úÖ Angular IIS deployment pipeline completed successfully." }
        failure { echo "‚ùå Deployment failed. Check logs for details." }
        always  { echo "‚ÑπÔ∏è Pipeline execution complete." }
    }
}